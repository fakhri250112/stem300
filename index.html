<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a">
<link rel="icon" href="icons/icon.png" type="image/png">


<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sunnah Lifestyle ‚Äî Final (TTS + Unified History)</title>

<!-- Tailwind CDN for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet for map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  /* small custom polish */
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(135deg,#0f172a,#0ea5a2 60%); color:#e6eef0; min-height:100vh; }
  .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); border-radius: 16px; box-shadow: 0 6px 20px rgba(2,6,23,0.6); }
  .mini { background: rgba(255,255,255,0.03); border-radius:12px; padding:0.75rem }
  .small-muted { color: rgba(230,238,240,0.7); font-size:0.9rem; }
  #map { height: 320px; border-radius:12px; }
  .pill { background: rgba(255,255,255,0.06); padding: .25rem .6rem; border-radius:999px; font-weight:600; }
</style>
</head>
<body class="py-8 px-4">

  <main class="max-w-3xl mx-auto">
    <header class="text-center mb-6">
      <div class="inline-block p-3 glass">
        <img src="https://cdn.pixabay.com/photo/2023/11/30/10/45/allah-8421334_1280.png" alt="icon" class="w-20 h-20 mx-auto rounded-full bg-white p-2" />
        <h1 class="text-2xl font-extrabold mt-2">Sunnah Lifestyle</h1>
        <p class="small-muted">Healthy habits ‚Ä¢ Prayer reminders ‚Ä¢ Sustainable living</p>
      </div>
    </header>

    <!-- Dashboard grid -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

      <!-- Time + Prayer -->
      <div class="glass p-5">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-lg font-bold">Current Time</h2>
            <div id="currentTime" class="text-2xl mt-1 font-semibold">--:--:--</div>
            <div id="locationDisplay" class="small-muted mt-1">Detecting location...</div>
          </div>
          <div class="text-right">
            <button id="enableNotifBtn" class="mt-2 px-3 py-2 bg-emerald-400 text-black rounded-md font-semibold">Enable Notifications</button>
            <div id="ttsToggleWrap" class="mt-2 small-muted">TTS: <span id="ttsStatus">on</span></div>
          </div>
        </div>

        <hr class="my-3 border-white/10" />
        <h3 class="font-semibold">Next Prayer</h3>
        <div id="nextPrayer" class="mt-2 text-lg">Loading...</div>
        <div id="prayerCountdown" class="small-muted mt-1">‚Äî</div>
        <ul id="prayerList" class="mt-3 space-y-1 small-muted"></ul>
      </div>

      <!-- Meals + countdown -->
      <div class="glass p-5">
        <h3 class="text-lg font-bold">Meals (fixed per day)</h3>
        <p class="small-muted">Menu is fixed for the day ‚Äî will update next day automatically.</p>
        <div class="mt-3 space-y-2">
          <div class="mini">
            <div class="flex justify-between items-center">
              <div><b>Breakfast</b><div class="small-muted">07:00</div></div>
              <div class="text-right">
                <div id="breakfastCountdown" class="font-medium">‚Äî</div>
                <div id="breakfastMenu" class="small-muted">Loading menu...</div>
              </div>
            </div>
          </div>

          <div class="mini">
            <div class="flex justify-between items-center">
              <div><b>Lunch</b><div class="small-muted">12:00</div></div>
              <div class="text-right">
                <div id="lunchCountdown" class="font-medium">‚Äî</div>
                <div id="lunchMenu" class="small-muted">Loading menu...</div>
              </div>
            </div>
          </div>

          <div class="mini">
            <div class="flex justify-between items-center">
              <div><b>Dinner</b><div class="small-muted">19:00</div></div>
              <div class="text-right">
                <div id="dinnerCountdown" class="font-medium">‚Äî</div>
                <div id="dinnerMenu" class="small-muted">Loading menu...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Exercise -->
      <div class="glass p-5">
        <h3 class="text-lg font-bold">Exercise Schedule</h3>
        <div class="small-muted">Daily routine</div>
        <ul class="mt-3 space-y-2">
          <li class="mini flex justify-between items-center">
            <div>
              <b>Morning Stretch</b><div class="small-muted">06:30</div>
            </div>
            <div class="text-right">
              <div id="stretchCountdown">‚Äî</div>
            </div>
          </li>

          <li class="mini flex justify-between items-center">
            <div>
              <b>Cardio (Jog / Skipping)</b><div class="small-muted">16:30</div>
            </div>
            <div class="text-right">
              <div id="cardioCountdown">‚Äî</div>
            </div>
          </li>

          <li class="mini flex justify-between items-center">
            <div>
              <b>Light Workout</b><div class="small-muted">20:30</div>
            </div>
            <div class="text-right">
              <div id="workoutCountdown">‚Äî</div>
            </div>
          </li>
        </ul>
      </div>

      <!-- Sleep + Fast toggle -->
      <div class="glass p-5">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-bold">Sleep</h3>
          <div class="pill">22:00</div>
        </div>
        <div class="mt-3 small-muted">Recommended sleep start</div>
        <div class="mt-3">
          <div id="sleepCountdown" class="font-medium">‚Äî</div>
        </div>

        <hr class="my-3 border-white/8" />

        <div class="flex items-center gap-2">
          <input type="checkbox" id="fastingMode" />
          <label for="fastingMode" class="small-muted">Ramadan Mode (auto) / Imsak & Iftar</label>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <input type="checkbox" id="sunnahMonThu" checked />
          <label for="sunnahMonThu" class="small-muted">Sunnah Mon & Thu fasting reminders</label>
        </div>

        <div class="mt-3 small-muted" id="fastingStatus">Fasting: Off</div>
        <div class="mt-2" id="fastingCountdown">‚Äî</div>
      </div>

    </section>

    <!-- Map + Activity -->
    <section class="glass p-5 mb-4">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-bold">Activity Tracker (Strava-like)</h3>
        <div class="small-muted">GPS-based route & stats</div>
      </div>

      <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div id="map" class="md:col-span-2"></div>
        <div class="space-y-2">
          <div class="mini">
            <div class="small-muted">Status</div>
            <div id="trackStatus">Idle</div>
          </div>
          <div class="mini">
            <div class="small-muted">Distance</div>
            <div id="trackDistance">0.00 km</div>
          </div>
          <div class="mini">
            <div class="small-muted">Elapsed</div>
            <div id="trackElapsed">00:00:00</div>
          </div>

          <div class="mt-2 space-y-1">
            <button id="startTrack" class="w-full bg-emerald-400 text-black py-2 rounded-md font-semibold">Start</button>
            <button id="pauseTrack" class="w-full bg-yellow-400 text-black py-2 rounded-md font-semibold">Pause</button>
            <button id="stopTrack" class="w-full bg-red-500 text-white py-2 rounded-md font-semibold">Stop & Save</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Trash & Eco-challenge -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="glass p-5">
        <h3 class="text-lg font-bold">‚ôªÔ∏è Trash Tracker</h3>
        <div class="small-muted">Log daily trash (grams)</div>

        <div class="mt-3 space-y-2">
          <input id="trashType" placeholder="Type (Plastic / Organic)" class="w-full p-2 rounded bg-white/5" />
          <input id="trashWeight" placeholder="Weight (grams)" type="number" class="w-full p-2 rounded bg-white/5" />
          <div class="flex gap-2">
            <button id="addTrashBtn" class="flex-1 bg-emerald-400 text-black py-2 rounded-md font-semibold">Add</button>
            <button id="clearTrashBtn" class="bg-white/6 text-white py-2 px-3 rounded-md">Clear</button>
          </div>
          <div class="mt-3 small-muted">Today log</div>
          <ul id="trashList" class="mt-2 small-muted space-y-1 max-h-40 overflow-auto"></ul>
          <div class="mt-2 font-semibold" id="trashTotal">Total: 0 g</div>
        </div>
      </div>

      <div class="glass p-5">
        <h3 class="text-lg font-bold">üå± Eco-Challenges</h3>
        <div class="small-muted">Complete tasks to earn eco points</div>
        <ul class="mt-3 space-y-2" id="challengeList"></ul>
        <div class="mt-3 small-muted">Points: <span id="ecoPoints">0</span></div>
      </div>
    </section>

    <footer class="text-center small-muted">App Developed by Fakhri - Project Developed by Group 3</footer>
  </main>

<script>
/* =========================
   Initialization & Helpers
   ========================= */

const nowEl = document.getElementById('currentTime');
const locationDisplay = document.getElementById('locationDisplay');
const enableNotifBtn = document.getElementById('enableNotifBtn');
const ttsStatusEl = document.getElementById('ttsStatus');

let notificationsEnabled = false;
let ttsEnabled = true; // we will use speechSynthesis for voice reminders
let userCoords = null;

// speech helper
function speak(text) {
  if (!ttsEnabled) return;
  try {
    const u = new SpeechSynthesisUtterance(text);
    // choose a voice if available (try to pick a natural English voice)
    const voices = speechSynthesis.getVoices();
    if (voices && voices.length) {
      const prefer = voices.find(v => /female|Google UK English|en-GB|en-US/i.test(v.name));
      if (prefer) u.voice = prefer;
    }
    u.rate = 1;
    speechSynthesis.cancel(); // avoid overlap
    speechSynthesis.speak(u);
  } catch (e) { console.warn('TTS error', e); }
}

// notification helper
async function showNotification(title, body) {
  if (!notificationsEnabled) return;
  try {
    new Notification(title, { body });
  } catch (e) { console.warn('Notification show error', e); }
}

// request notification permission
enableNotifBtn.addEventListener('click', async () => {
  if (!('Notification' in window)) { alert('This browser does not support notifications.'); return; }
  const p = await Notification.requestPermission();
  notificationsEnabled = (p === 'granted');
  enableNotifBtn.textContent = notificationsEnabled ? 'Notifications Enabled' : 'Enable Notifications';
});

// current time update
function pad(n){ return n.toString().padStart(2,'0'); }
function updateClock(){
  const d = new Date();
  nowEl.textContent = d.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

/* =========================
   Prayer times (Aladhan)
   ========================= */

let prayerTimings = {}; // will hold times as "HH:MM"
let hijriInfo = null;

async function fetchPrayerTimes(lat, lon) {
  try {
    const timestamp = Math.floor(Date.now()/1000);
    const url = `https://api.aladhan.com/v1/timings/${timestamp}?latitude=${lat}&longitude=${lon}&method=2`;
    const res = await fetch(url);
    const data = await res.json();
    if (data && data.data && data.data.timings) {
      prayerTimings = data.data.timings; // includes Fajr, Sunrise, Dhuhr, Asr, Maghrib, Isha
      hijriInfo = data.data.date && data.data.date.hijri ? data.data.date.hijri : null;
      renderPrayerList();
      evaluateFastingMode();
    } else {
      throw new Error('Invalid API data');
    }
  } catch (e) {
    console.warn('Aladhan fetch failed, fallback to defaults', e);
    // fallback static times (as earlier)
    prayerTimings = { Fajr: '05:00', Dhuhr: '12:00', Asr: '15:00', Maghrib: '18:00', Isha: '20:00' };
    renderPrayerList();
  }
}

function renderPrayerList() {
  const list = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  const ul = document.getElementById('prayerList');
  ul.innerHTML = list.map(p => `<li><b>${p}</b>: ${prayerTimings[p] || '‚Äî'}</li>`).join('');
  document.getElementById('nextPrayer').textContent = computeNextPrayerText();
}

// helpers to parse HH:MM to Date today
function timeToTodayDate(hhmm) {
  const [hh, mm] = (hhmm || '00:00').split(':').map(Number);
  const d = new Date();
  d.setHours(hh, mm, 0, 0);
  return d;
}
function computeNextPrayerText() {
  const now = new Date();
  const order = ['Fajr','Dhuhr','Asr','Maghrib','Isha'];
  for (const p of order) {
    if (prayerTimings[p]) {
      const t = timeToTodayDate(prayerTimings[p]);
      if (t > now) return `${p} ${prayerTimings[p]}`;
    }
  }
  // next is tomorrow Fajr
  const t = prayerTimings['Fajr'] ? prayerTimings['Fajr'] : '05:00';
  return `Fajr ${t} (tomorrow)`;
}

/* =========================
   Meals (fixed per day)
   ========================= */

const todayKey = () => {
  const d = new Date();
  return `menus-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
};

const defaultMenus = {
  breakfast: "Dates & milk ‚Äî Prophet‚Äôs breakfast",
  lunch: "Brown rice & grilled chicken ‚Äî balanced",
  dinner: "Light vegetable soup & fruit ‚Äî easy digestion"
};

function loadMenusForToday() {
  let menus = JSON.parse(localStorage.getItem(todayKey()) || 'null');
  if (!menus) {
    menus = {...defaultMenus};
    // store and keep fixed for the day
    localStorage.setItem(todayKey(), JSON.stringify(menus));
  }
  document.getElementById('breakfastMenu').textContent = menus.breakfast;
  document.getElementById('lunchMenu').textContent = menus.lunch;
  document.getElementById('dinnerMenu').textContent = menus.dinner;
}
loadMenusForToday();

/* =========================
   Scheduler for reminders
   ========================= */

let scheduledEvents = []; // {id, name, date:Date, category, data}
let triggeredIds = new Set();

function scheduleEvent(id, name, date, category, data={}) {
  if (!date || isNaN(date.getTime())) return;
  scheduledEvents.push({id, name, date, category, data});
}

// build events for today
function buildDailySchedule() {
  scheduledEvents = [];
  triggeredIds = new Set();

  const now = new Date();

  // Prayer events
  ['Fajr','Dhuhr','Asr','Maghrib','Isha'].forEach(p => {
    if (prayerTimings[p]) {
      const d = timeToTodayDate(prayerTimings[p]);
      scheduleEvent(`prayer-${p}`, `Prayer: ${p}`, d, 'prayer', {prayer:p});
    }
  });

  // Meals
  const breakfast = timeToTodayDate('07:00');
  const lunch = timeToTodayDate('12:00');
  const dinner = timeToTodayDate('19:00');
  scheduleEvent('meal-breakfast','Breakfast', breakfast, 'meal', {menu: document.getElementById('breakfastMenu').textContent, meal:'Breakfast'});
  scheduleEvent('meal-lunch','Lunch', lunch, 'meal', {menu: document.getElementById('lunchMenu').textContent, meal:'Lunch'});
  scheduleEvent('meal-dinner','Dinner', dinner, 'meal', {menu: document.getElementById('dinnerMenu').textContent, meal:'Dinner'});

  // Exercise
  scheduleEvent('ex-stretch','Morning Stretch', timeToTodayDate('06:30'), 'exercise', {});
  scheduleEvent('ex-cardio','Cardio', timeToTodayDate('16:30'), 'exercise', {});
  scheduleEvent('ex-workout','Light Workout', timeToTodayDate('20:30'), 'exercise', {});

  // Sleep
  scheduleEvent('sleep','Sleep time', timeToTodayDate('22:00'), 'sleep', {});

  // Fasting (Ramadan detection and Mon/Thu)
  evaluateFastingMode(); // will add if necessary

  // sort events by date
  scheduledEvents.sort((a,b)=>a.date-b.date);
}
function evaluateFastingMode() {
  // Ramadan if hijri month number == 9
  const fastingToggle = document.getElementById('fastingMode');
  let ramadanDetected = false;
  if (hijriInfo && hijriInfo.month && hijriInfo.month.number) {
    ramadanDetected = (hijriInfo.month.number === 9);
  }
  // auto enable fasting checkbox if ramadan detected
  if (ramadanDetected) {
    fastingToggle.checked = true;
  }
  const sunnahToggle = document.getElementById('sunnahMonThu');
  const today = new Date();
  const weekday = today.getDay(); // 0 Sun ... 1 Mon ... 4 Thu ...
  // if fasting mode on OR ramadan or monday/thu (if sunnah toggle)
  const fastOn = fastingToggle.checked;
  const sunnahOn = sunnahToggle.checked && (weekday === 1 || weekday === 4);
  const fastingStatusEl = document.getElementById('fastingStatus');
  fastingStatusEl.textContent = fastOn ? 'Fasting Mode: On (Ramadan or manual)' : 'Fasting Mode: Off';
  // clear previous fasting events
  scheduledEvents = scheduledEvents.filter(e => !e.id.startsWith('fast-'));
  // if fasting (Ramadan) or sunnah Mon/Thu add imsak & iftar
  if (fastOn || sunnahOn || ramadanDetected) {
    // Imsak: 10 minutes before Fajr (if we have Fajr)
    if (prayerTimings['Fajr']) {
      const fajrDate = timeToTodayDate(prayerTimings['Fajr']);
      const imsakDate = new Date(fajrDate.getTime() - 10*60000);
      scheduleEvent('fast-imsak','Imsak (stop eating)', imsakDate, 'fast', {type:'imsak'});
    }
    if (prayerTimings['Maghrib']) {
      const maghribDate = timeToTodayDate(prayerTimings['Maghrib']);
      scheduleEvent('fast-iftar','Iftar (break fast)', maghribDate, 'fast', {type:'iftar'});
    }
  }
}

/* =========================
   Countdown UI & trigger loop
   ========================= */

function msToHMS(ms) {
  if (ms < 0) ms = 0;
  const s = Math.floor(ms/1000) % 60;
  const m = Math.floor(ms/60000) % 60;
  const h = Math.floor(ms/3600000);
  return `${pad(h)}:${pad(m)}:${pad(s)}`;
}
function msToFriendly(ms) {
  if (ms <= 0) return 'Now';
  const s = Math.floor(ms/1000) % 60;
  const m = Math.floor(ms/60000) % 60;
  const h = Math.floor(ms/3600000);
  if (h>0) return `${h}h ${m}m ${s}s`;
  if (m>0) return `${m}m ${s}s`;
  return `${s}s`;
}

function updateCountdowns() {
  const now = new Date();

  // next prayer countdown
  const nextPrayerEvent = scheduledEvents.find(e => e.category === 'prayer' && e.date > now);
  if (nextPrayerEvent) {
    const ms = nextPrayerEvent.date - now;
    document.getElementById('prayerCountdown').textContent = `Next: ${nextPrayerEvent.name} ‚Äî ${msToFriendly(ms)}`;
  } else {
    document.getElementById('prayerCountdown').textContent = 'No more prayers today';
  }

  // meals countdowns
  const breakfastEvent = scheduledEvents.find(e=>e.id==='meal-breakfast');
  const lunchEvent = scheduledEvents.find(e=>e.id==='meal-lunch');
  const dinnerEvent = scheduledEvents.find(e=>e.id==='meal-dinner');
  document.getElementById('breakfastCountdown').textContent = breakfastEvent ? msToFriendly(breakfastEvent.date - now) : '‚Äî';
  document.getElementById('lunchCountdown').textContent = lunchEvent ? msToFriendly(lunchEvent.date - now) : '‚Äî';
  document.getElementById('dinnerCountdown').textContent = dinnerEvent ? msToFriendly(dinnerEvent.date - now) : '‚Äî';

  // exercise
  ['ex-stretch','ex-cardio','ex-workout'].forEach(id=>{
    const ev = scheduledEvents.find(e=>e.id===id);
    const el = id==='ex-stretch' ? 'stretchCountdown' : id==='ex-cardio' ? 'cardioCountdown' : 'workoutCountdown';
    document.getElementById(el).textContent = ev ? msToFriendly(ev.date - now) : '‚Äî';
  });

  // sleep
  const sleepEv = scheduledEvents.find(e=>e.id==='sleep');
  document.getElementById('sleepCountdown').textContent = sleepEv ? msToFriendly(sleepEv.date - now) : '‚Äî';

  // fasting countdown: next fast event (imsak or iftar)
  const fastEv = scheduledEvents.find(e=>e.category==='fast' && e.date > now);
  if (fastEv) {
    document.getElementById('fastingCountdown').textContent = `${fastEv.name} in ${msToFriendly(fastEv.date - now)}`;
  } else {
    document.getElementById('fastingCountdown').textContent = 'No fasting reminders today';
  }

  // trigger events if <= 0 and not yet triggered
  scheduledEvents.forEach(ev=>{
    const remaining = ev.date - now;
    if (remaining <= 0 && !triggeredIds.has(ev.id)) {
      // trigger
      triggeredIds.add(ev.id);
      handleEventTrigger(ev);
    }
  });
}
setInterval(updateCountdowns, 1000);

/* =========================
   Event trigger action
   ========================= */

function handleEventTrigger(ev) {
  // category: prayer / meal / exercise / sleep / fast
  switch(ev.category) {
    case 'prayer':
      speak(`It is time for ${ev.data.prayer} prayer.`);
      showNotification('Prayer Reminder', `Time for ${ev.data.prayer} prayer`);
      break;
    case 'meal':
      speak(`Time for ${ev.data.meal}. Today's menu is: ${ev.data.menu}`);
      showNotification('Meal Reminder', `Time for ${ev.data.meal}`);
      break;
    case 'exercise':
      speak(`Time to exercise. ${ev.name}`);
      showNotification('Exercise Reminder', ev.name);
      break;
    case 'sleep':
      speak(`Time to sleep. Good night.`);
      showNotification('Sleep Reminder', 'Time to sleep');
      break;
    case 'fast':
      if (ev.data.type === 'imsak') {
        speak(`Imsak. Stop eating now.`);
        showNotification('Imsak', 'Stop eating now');
      } else if (ev.data.type === 'iftar') {
        speak(`Alhamdulillah. It is time to break your fast.`);
        showNotification('Iftar', 'Time to break your fast');
      }
      break;
  }
}

/* =========================
   Periodic rebuild schedule (every 5 minutes / on location change)
   ========================= */

function rebuildScheduleAndUI() {
  buildDailySchedule();
  updateCountdowns();
}
setInterval(()=>{ rebuildScheduleAndUI(); }, 5*60*1000); // refresh schedule every 5 minutes

/* =========================
   Location detection & Aladhan init
   ========================= */

function initLocationAndPrayer() {
  if (!navigator.geolocation) {
    locationDisplay.textContent = 'Geolocation not supported. Using Jakarta fallback.';
    userCoords = {lat: -6.2088, lon: 106.8456}; // Jakarta fallback
    fetchPrayerTimes(userCoords.lat, userCoords.lon).then(()=>{ buildDailySchedule(); });
    return;
  }
  // get current
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    userCoords = {lat, lon};
    locationDisplay.textContent = `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    fetchPrayerTimes(lat, lon).then(()=>{ buildDailySchedule(); });
  }, err=>{
    console.warn('Location denied or error', err);
    locationDisplay.textContent = 'Location denied. Using Jakarta fallback.';
    userCoords = {lat: -6.2088, lon: 106.8456};
    fetchPrayerTimes(userCoords.lat, userCoords.lon).then(()=>{ buildDailySchedule(); });
  }, {enableHighAccuracy:true, timeout:8000});
}

initLocationAndPrayer();

/* =========================
   GPS Tracking (Leaflet)
   ========================= */

let map, polyline, watchIdTrack = null, tracking = false;
let trackCoords = [], trackStart = null, trackElapsedInterval = null, trackDist = 0;

function initMap() {
  map = L.map('map', {zoomControl:false}).setView([userCoords ? userCoords.lat : 0, userCoords ? userCoords.lon : 0], userCoords ? 14 : 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  polyline = L.polyline([], {color:'#06b6d4'}).addTo(map);
}
initMap();

function haversineDist(a,b) {
  const R = 6371e3;
  const œÜ1 = a.lat*Math.PI/180, œÜ2 = b.lat*Math.PI/180;
  const ŒîœÜ = (b.lat-a.lat)*Math.PI/180;
  const ŒîŒª = (b.lon-a.lon)*Math.PI/180;
  const aa = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
  const c = 2*Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
  return R * c; // meters
}

function startTracking() {
  if (!navigator.geolocation) return alert('Geolocation not supported');
  if (tracking) return;
  trackCoords = []; trackDist = 0;
  trackStart = new Date();
  document.getElementById('trackStatus').textContent = 'Tracking...';
  tracking = true;
  polyline.setLatLngs([]);
  watchIdTrack = navigator.geolocation.watchPosition(p=>{
    const lat = p.coords.latitude, lon = p.coords.longitude;
    const point = {lat, lon, ts: Date.now()};
    if (trackCoords.length>0) {
      const last = trackCoords[trackCoords.length-1];
      const d = haversineDist({lat:last.lat, lon:last.lon}, {lat, lon});
      if (!isNaN(d) && d>0) trackDist += d;
    }
    trackCoords.push(point);
    polyline.addLatLng([lat, lon]);
    map.setView([lat, lon], 15);
    document.getElementById('trackDistance').textContent = `${(trackDist/1000).toFixed(2)} km`;
  }, err=>{ console.warn('track err', err); }, {enableHighAccuracy:true, maximumAge:1000});
  // elapsed
  trackElapsedInterval = setInterval(()=>{
    const s = Math.floor((Date.now() - trackStart.getTime())/1000);
    const hh = pad(Math.floor(s/3600));
    const mm = pad(Math.floor((s%3600)/60));
    const ss = pad(s%60);
    document.getElementById('trackElapsed').textContent = `${hh}:${mm}:${ss}`;
  }, 1000);
}

function pauseTracking() {
  if (!tracking) return;
  if (watchIdTrack) {
    navigator.geolocation.clearWatch(watchIdTrack);
    watchIdTrack = null;
    document.getElementById('trackStatus').textContent = 'Paused';
  }
  if (trackElapsedInterval) { clearInterval(trackElapsedInterval); trackElapsedInterval = null; }
  tracking = false;
}

function stopAndSaveTracking() {
  if (watchIdTrack) navigator.geolocation.clearWatch(watchIdTrack);
  if (trackElapsedInterval) clearInterval(trackElapsedInterval);
  document.getElementById('trackStatus').textContent = 'Stopped';
  // save to localStorage as a run
  if (trackCoords.length > 0) {
    const runs = JSON.parse(localStorage.getItem('runs')||'[]');
    runs.push({id: Date.now(), coords: trackCoords, dist_m: Math.round(trackDist), start: trackStart});
    localStorage.setItem('runs', JSON.stringify(runs));
    speak(`Run saved. Distance ${(trackDist/1000).toFixed(2)} kilometers.`);
    alert('Activity saved!');
  } else {
    alert('No activity recorded.');
  }
  // reset
  trackCoords = []; trackDist = 0;
  document.getElementById('trackDistance').textContent = '0.00 km';
  document.getElementById('trackElapsed').textContent = '00:00:00';
  tracking = false;
  watchIdTrack = null;
}

document.getElementById('startTrack').addEventListener('click', startTracking);
document.getElementById('pauseTrack').addEventListener('click', pauseTracking);
document.getElementById('stopTrack').addEventListener('click', stopAndSaveTracking);

/* =========================
   Trash tracker & Eco-challenges
   ========================= */

let trashLog = JSON.parse(localStorage.getItem('trashLog')||'[]');
function renderTrash() {
  const ul = document.getElementById('trashList');
  const today = new Date().toLocaleDateString();
  const todayLog = trashLog.filter(t=>t.date===today);
  ul.innerHTML = todayLog.map(t=>`<li>${t.time} ‚Äî ${t.type}: ${t.weight} g</li>`).join('') || '<li class="small-muted">No entries today</li>';
  const total = todayLog.reduce((s,t)=>s+t.weight,0);
  document.getElementById('trashTotal').textContent = `Total: ${total} g`;
}
renderTrash();

document.getElementById('addTrashBtn').addEventListener('click', ()=>{
  const type = document.getElementById('trashType').value.trim() || 'Other';
  const weight = parseInt(document.getElementById('trashWeight').value) || 0;
  if (!weight) return alert('Enter weight in grams');
  const now = new Date();
  trashLog.push({date: now.toLocaleDateString(), time: now.toLocaleTimeString(), type, weight});
  localStorage.setItem('trashLog', JSON.stringify(trashLog));
  document.getElementById('trashType').value=''; document.getElementById('trashWeight').value='';
  renderTrash();
});
document.getElementById('clearTrashBtn').addEventListener('click', ()=>{
  if (!confirm('Clear all trash logs?')) return;
  trashLog=[]; localStorage.setItem('trashLog','[]'); renderTrash();
});

/* Eco challenges */

const challengesTemplate = [
  {id:'c1', text:'Bring your own water bottle', pts:5},
  {id:'c2', text:'Use a reusable bag', pts:4},
  {id:'c3', text:'Cycle instead of driving for 2 km', pts:8},
  {id:'c4', text:'Pick up 3 pieces of trash', pts:6},
];
let ecoPoints = parseInt(localStorage.getItem('ecoPoints')||'0');

function renderChallenges() {
  const ul = document.getElementById('challengeList');
  const done = JSON.parse(localStorage.getItem('chDone')||'{}');
  ul.innerHTML = challengesTemplate.map(c=>{
    const checked = done[c.id] ? 'checked' : '';
    return `<li class="mini flex justify-between items-center"><div><input type="checkbox" data-id="${c.id}" ${checked} /> <span class="small-muted ml-2">${c.text}</span></div><div class="small-muted">${c.pts} pts</div></li>`;
  }).join('');
  document.getElementById('ecoPoints').textContent = ecoPoints;
  // attach listeners
  ul.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', (e)=>{
      const id = cb.dataset.id;
      const conf = challengesTemplate.find(x=>x.id===id);
      const doneObj = JSON.parse(localStorage.getItem('chDone')||'{}');
      if (cb.checked) {
        doneObj[id] = true;
        ecoPoints += conf.pts;
      } else {
        delete doneObj[id];
        ecoPoints -= conf.pts;
      }
      localStorage.setItem('chDone', JSON.stringify(doneObj));
      localStorage.setItem('ecoPoints', ecoPoints);
      document.getElementById('ecoPoints').textContent = ecoPoints;
    });
  });
}
renderChallenges();

/* =========================
   UI Toggling & Fast Mode toggles
   ========================= */

document.getElementById('fastingMode').addEventListener('change', ()=>{
  evaluateFastingMode();
  rebuildScheduleAndUI();
});
document.getElementById('sunnahMonThu').addEventListener('change', ()=>{
  evaluateFastingMode();
  rebuildScheduleAndUI();
});

/* =========================
   On first load: build schedule
   ========================= */

setTimeout(()=>{ // slight delay to allow location fetch
  buildDailySchedule();
  updateCountdowns();
}, 1200);

/* =========================
   Menu fixed next-day update (midnight job)
   ========================= */

function midnightCheckForNewDay() {
  const now = new Date();
  const tomorrow = new Date();
  tomorrow.setHours(0,0,1,0);
  // compute ms to next midnight
  const ms = (24 - now.getHours())*3600000 - now.getMinutes()*60000 - now.getSeconds()*1000 + 1000;
  setTimeout(()=>{
    // new day: remove today's menu key so next page load creates new menu for new day
    // but we want menu to change next day automatically (we'll generate a new default)
    // remove localStorage menu for yesterday so next-day call uses default and fix it.
    // Actually simpler: set new menu for new day (could randomize)
    const d = new Date();
    const key = `menus-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    // auto-generate new menus (simple random selection)
    const breakfastOpts = [
      "Dates & milk ‚Äî Prophet‚Äôs breakfast",
      "Honey & banana ‚Äî energy",
      "Barley bread & yogurt"
    ];
    const lunchOpts = [
      "Brown rice & grilled chicken",
      "Quinoa & tuna salad",
      "Whole grain bread & hummus"
    ];
    const dinnerOpts = [
      "Light veggie soup & yogurt",
      "Goat milk & dates",
      "Fresh fruits & tea"
    ];
    const menus = {
      breakfast: breakfastOpts[Math.floor(Math.random()*breakfastOpts.length)],
      lunch: lunchOpts[Math.floor(Math.random()*lunchOpts.length)],
      dinner: dinnerOpts[Math.floor(Math.random()*dinnerOpts.length)]
    };
    localStorage.setItem(key, JSON.stringify(menus));
    // reload menus loaded in UI
    loadMenusForToday();
    // rebuild schedule
    buildDailySchedule();
    // schedule next midnight
    midnightCheckForNewDay();
  }, ms);
}
midnightCheckForNewDay();

/* =========================
   Keep map centered when user coords available
   ========================= */
setInterval(()=>{
  if (userCoords && map) {
    map.setView([userCoords.lat, userCoords.lon], map.getZoom());
  }
}, 20*1000);

/* =========================
   Graceful voice + notification fallback
   ========================= */

window.addEventListener('beforeunload', ()=> {
  speechSynthesis.cancel();
});

</script>

</body>
</html>






